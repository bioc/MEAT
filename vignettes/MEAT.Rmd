---
title: "MEAT (Muscle Epigenetic Age Test)"
author:
- name: "Sarah Voisin"
  affiliation: "Institute for Health and Sport (iHeS), Victoria University, Footscray, VIC 3011, Australia"
  email: "sarah.voisin.aeris@gmail.com"
package: MEAT
date: "`r Sys.Date()`"
output:  BiocStyle::html_vignette
vignette: >
  %\VignetteIndexEntry{MEAT}
  %\VignetteEngine{knitr::knitr}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  fig.width = 8,
  collapse = TRUE,
  comment = "#>"
)
```

```{r style, echo = FALSE, results = 'asis'}
BiocStyle::markdown()
```

![](Ecorche_logo.jpg)

# Introduction

Welcome to MEAT (Muscle Epigenetic Age Test)! If you are reading these lines, you are probably an inquisitive scientist who has put a lot of effort into collecting skeletal muscle samples from -- hopefully -- consenting humans. Your coin purse (grant) is now lighter after profiling these muscle samples with the **Illumina HumanMethylation technology (HM27, HM450 and HMEPIC)** and you are yearning to know what the skeletal muscle epigenome has to say about your samples' age. I am here to guide you in your quest to find out how old your skeletal muscle samples are, by simply looking at their DNA methylation profiles. DNA methylation doesn't lie, but it can be tricky to understand what it says. Are you ready to undertake your quest to uncover the secrets of the muscle epigenome?  

You can view MEAT as a spellbook (package) that contains all the necessary spells (functions) to estimate epigenetic age in human skeletal muscle samples. However, the spells will only work if you cast them in a particular order (data cleaning, data calibration, and epigenetic age estimation). Starting from preprocessed data (matrix of beta-values that has been normalized/batch corrected, etc.), MEAT will estimate epigenetic age in each sample, based on [a penalized regression model developed by Voisin et al. on 682 skeletal muscle samples from 12 independent datasets ](https://www.biorxiv.org/content/10.1101/821009v3). This muscle epigenetic clock is a machine learning algorithm (elastic net regression) essentially similar to [Horvath's original pan-tissue clock](https://genomebiology.biomedcentral.com/articles/10.1186/gb-2013-14-10-r115).  
You have the option to provide the actual age of each sample (if known), so MEAT can calculate age acceleration (difference between epigenetic age and real age). MEAT can also perform statistical tests to associate age acceleration with phenotypes of interest.

# Installation

To install the MEAT package, type:
```{r MEAT package installation, eval=FALSE}
if (!requireNamespace("BiocManager", quietly=TRUE))
    install.packages("BiocManager")
BiocManager::install("MEAT")
```

Then, you can load the package by typing:
```{r loading package, message=FALSE, warning=FALSE}
library(MEAT)
```

# Step-by-step guide

## Data requirements

To use this guide, you will need in your inventory:

* **a matrix or data frame of beta-values**. Epigenetic age estimation will be more accurate if the beta matrix is already preprocessed using one of the many available R packages intended for this purpose (e.g. [ChAMP](https://bioconductor.org/packages/release/bioc/vignettes/ChAMP/inst/doc/ChAMP.html)). Preprocessing typically involves probe and sample filtering, normalisation of Type I and Type II probes, and correction for batch effects. The beta-matrix should have *CpGs in rows* and *samples in columns*, like this:
```{r Methylation matrix presentation}
data("GSE121961", envir = environment())
knitr::kable(head(GSE121961),
             caption = "Top rows of the GSE121961 matrix before cleaning and calibration.")
```
* **an optional phenotype table**. This phenotype table contains information on the samples provided in the beta-matrix, such as age (e.g. 0-122 years old for a human, 0-700 for an elf, 0-500 for a dwarf), sex (male, female, intersex), disease status (healthy/control, diseased/case/zombie delirium/hydrophobia/ogre poisoning), etc. The table should have *samples in rows* and *phenotypes in columns*, like this:
```{r Phenotype table presentation}
data("GSE121961_pheno", envir = environment())
knitr::kable(GSE121961_pheno,
             caption = "Phenotypes corresponding to GSE121961.")
```
The phenotype table is useful if you want to discover the age acceleration of your samples and to associate this age acceleration with a phenotype of interest (e.g. do elves show systematically lower age acceleration than humans, therefore explaining their exceptional lifespans?)

## Step 1: Data cleaning

The first important step is data 'cleaning', which essentially means *reducing the beta matrix to the 19,401 CpGs common to the 12 datasets used in the muscle clock*. If some of the 19,401 CpGs are not present in your beta-matrix, these missing values will be imputed.
```{r Data cleaning, message=FALSE, warning=FALSE}
GSE121961_clean <- clean_beta(beta = GSE121961)
knitr::kable(head(GSE121961_clean),
             caption = "Top rows of the GSE121961 matrix after cleaning.")
```

## Step 2: Data calibration

The second step is data 'calibration', which essentially means *re-scaling the DNA methylation profiles to that of the gold standard dataset used to develop the muscle clock*. This step harmonises differences in data processing, sample preparation, lab-to-lab variability, to obtain accurate measures of epigenetic age in your samples.
It should be noted that this 'calibration' is entirely different from the previously mentioned data preprocessing (i.e. probe and sample filtering, normalisation of Type I and Type II probes, and correction for batch effects). The calibration implemented in BMIQcalibration() does use code from the original BMIQ algorithm, but it is **not** used to normalize TypeI and TypeII probe methylation distribution. The BMIQcalibration() of the MEAT package re-scales the methylation distribution of your samples to the gold standard dataset GSE50498 [](https://www.biorxiv.org/content/10.1101/821009v3).
```{r Data calibration, message=FALSE, warning=FALSE}
GSE121961_calibrated <- BMIQcalibration(datM = GSE121961_clean)
knitr::kable(head(GSE121961_calibrated),
             caption = "Top rows of the GSE121961 matrix after cleaning and calibration.")
```
You can have a look at the distribution of DNA methylation before and after calibration with a density plot. On this plot, each line is an individual sample, and you can clearly see the bimodal distribution of DNA methylation data, with most CpGs harboring very low methylation levels (left side of the graph), very few CpGs with intermediate methylation levels, and some CpGs with high methylation levels.
Before calibration, the profiles do not align well with that of the gold standard, and this is problematic to obtain accurate estimates of epigenetic age. However, after calibration, the samples' profiles overlap nicely with that of the gold standard.
```{r DNA methylation profile distribution before and after calibration, message=FALSE, warning=FALSE}
data("gold.mean", envir = environment())
GSE121961_clean_with_gold_mean <- cbind(GSE121961_clean, gold.mean$gold.mean) # add the gold mean
GSE121961_calibrated_with_gold_mean <- cbind(GSE121961_calibrated, gold.mean$gold.mean) # add the gold mean
groups <- c(rep("GSE121961", ncol(GSE121961_clean)), "Gold mean")

library(minfi)
par(mfrow = c(2, 1))
densityPlot(GSE121961_clean_with_gold_mean,
  sampGroups = groups,
  main = "Before calibration",
  legend = FALSE
)
densityPlot(GSE121961_calibrated_with_gold_mean,
  sampGroups = groups,
  main = "After calibration"
)
```

## Step 3: Epigenetic age estimation

Your quest is almost over! The only spell left to cast is _epiage_estimation()_ that uses methylation levels at 200 CpGs from the calibrated profiles to estimate epigenetic age.
If you do not have information on age, _epiage_estimation()_ will only return epigenetic age ("DNAmage").
```{r Epigenetic age estimation without phenotypes, message=FALSE, warning=FALSE}
data("GSE121961_pheno", envir = environment())
GSE121961_epiage <- epiage_estimation(
  beta = GSE121961_calibrated,
  pheno = NULL
)
GSE121961_epiage
```
However, if you have information on age (and other phenotypes), _epiage_estimation()_ will return:

* epigenetic age (**DNAmage**)
* age acceleration calculated as the difference between epigenetic age and actual age (**AAdiff**)
* age acceleration calculated as the residuals of a regression of predicted age against actual age (**AAresid**)

While AAdiff is a straightforward way of calculating the error in age prediction, it is sensitive to the mean age of the dataset and to the pre-processing of the DNA methylation dataset; AAdiff can be biased upwards or downwards depending on how the dataset was normalized, and depending on the mean age and age variance of the dataset. In contrast, AAresid is insensitive to the mean age of the dataset and is robust against different pre-processing methods.
```{r Epigenetic age estimation with phenotypes, message=FALSE, warning=FALSE}
data("GSE121961_pheno", envir = environment())
GSE121961_epiage <- epiage_estimation(
  beta = GSE121961_calibrated,
  pheno = GSE121961_pheno,
  ID_col_name = "ID",
  age_col_name = "Age"
)
knitr::kable(GSE121961_epiage,
             caption = "Phenotypes corresponding to GSE121961 with AAdiff and AAresid added for each sample.")
```

## Session information
```{r session info}
sessionInfo()
```
